<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-IDS - æ•°æ®å¯è§†åŒ–</title>
    <link rel="stylesheet" href="./css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
</head>

<body>
    <div class="app-container">
        <!-- å¤´éƒ¨å¯¼èˆª -->
        <header class="header">
            <div class="logo">
                <img src="./images/logo.png" alt="Logo" class="logo-img">
                <span>AIå…¥ä¾µæ£€æµ‹ç³»ç»Ÿ</span>
            </div>
            <div id="header-status"></div>
        </header>

        <!-- ä¸»ä½“å†…å®¹ -->
        <div class="main-container">
            <!-- ä¾§è¾¹æ  -->
            <div class="sidebar">
                <ul class="nav-menu">
                    <li class="nav-menu-item" onclick="location.href='./model-management.html'">
                        <span class="nav-menu-icon">âš™ï¸</span> æ¨¡å‹ç®¡ç†
                    </li>
                    <li class="nav-menu-item" onclick="location.href='./zeroday-history.html'">
                        <span class="nav-menu-icon">ğŸ”</span> é›¶æ—¥æ”»å‡»å†å²
                    </li>
                    <li class="nav-menu-item active" onclick="location.href='./data-visualization.html'">
                        <span class="nav-menu-icon">ğŸ“Š</span> æ•°æ®å¯è§†åŒ–
                    </li>
                </ul>
            </div>

            <!-- å†…å®¹åŒºåŸŸ -->
            <div class="content">
                <h1>æ•°æ®å¯è§†åŒ–</h1>

                <!-- å›¾è¡¨æ§åˆ¶é¢æ¿ -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">å›¾è¡¨æ§åˆ¶</h2>
                        <button class="btn btn-primary" id="refresh-charts">
                            <span class="btn-icon">ğŸ”„</span> åˆ·æ–°æ‰€æœ‰å›¾è¡¨
                        </button>
                    </div>
                    <div class="chart-controls">
                        <div class="row">
                            <div class="col col-6">
                                <div class="form-group">
                                    <label class="form-label">æ¨¡å‹æ•£ç‚¹å›¾æ•°æ®èŒƒå›´ (å¤©)</label>
                                    <select class="form-control" id="model-chart-days">
                                        <option value="1">æœ€è¿‘1å¤©</option>
                                        <option value="3">æœ€è¿‘3å¤©</option>
                                        <option value="7" selected>æœ€è¿‘7å¤©</option>
                                        <option value="14">æœ€è¿‘14å¤©</option>
                                        <option value="30">æœ€è¿‘30å¤©</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col col-6">
                                <div class="form-group">
                                    <label class="form-label">å¯¼å‡ºå›¾è¡¨</label>
                                    <button class="btn btn-success" id="export-charts">
                                        <span class="btn-icon">ğŸ“¥</span> å¯¼å‡ºå½“å‰å›¾è¡¨
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å›¾è¡¨å±•ç¤ºåŒºåŸŸ -->
                <div class="row">
                    <!-- æ¯æ—¥å‘Šè­¦ç»Ÿè®¡ -->
                    <div class="col col-6">
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">æ¯æ—¥å‘Šè­¦ç»Ÿè®¡</h2>
                            </div>
                            <div class="chart-container" id="daily-alerts-chart">
                                <div class="loading">
                                    <div class="loading-spinner"></div>
                                    <span>åŠ è½½ä¸­...</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æ”»å‡»ç±»å‹åˆ†å¸ƒ -->
                    <div class="col col-6">
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">é›¶æ—¥æ”»å‡»ç±»å‹åˆ†å¸ƒ</h2>
                            </div>
                            <div class="chart-container" id="category-distribution-chart">
                                <div class="loading">
                                    <div class="loading-spinner"></div>
                                    <span>åŠ è½½ä¸­...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- æœˆåº¦è¶‹åŠ¿ -->
                    <div class="col col-6">
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">é›¶æ—¥æ”»å‡»æœˆåº¦è¶‹åŠ¿</h2>
                            </div>
                            <div class="chart-container" id="monthly-trend-chart">
                                <div class="loading">
                                    <div class="loading-spinner"></div>
                                    <span>åŠ è½½ä¸­...</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æºIPç»Ÿè®¡ -->
                    <div class="col col-6">
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">å†…ç½‘æ”»å‡»æºIPç»Ÿè®¡</h2>
                            </div>
                            <div class="chart-container" id="ip-attack-stats-chart">
                                <div class="loading">
                                    <div class="loading-spinner"></div>
                                    <span>åŠ è½½ä¸­...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ¨¡å‹æ•£ç‚¹å›¾ -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">å‘Šè­¦æ•°æ®æ¨¡å‹åˆ†å¸ƒ</h2>
                        <div>
                            <span class="legend-item">
                                <span class="legend-color" style="background-color: #52c41a;"></span> æ­£å¸¸
                            </span>
                            <span class="legend-item">
                                <span class="legend-color" style="background-color: #faad14;"></span> å¯ç–‘
                            </span>
                            <span class="legend-item">
                                <span class="legend-color" style="background-color: #f5222d;"></span> å¼‚å¸¸
                            </span>
                            <span class="legend-item">
                                <span class="legend-color"
                                    style="background-color: #000; transform: rotate(45deg);"></span> èšç±»ä¸­å¿ƒ
                            </span>
                        </div>
                    </div>
                    <div class="chart-container" style="height: 500px;" id="model-distribution-chart">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                            <span>åŠ è½½ä¸­...</span>
                        </div>
                    </div>
                    <div class="chart-description">
                        <p><strong>å›¾è¡¨è¯´æ˜ï¼š</strong> å‘Šè­¦æ•°æ®æ¨¡å‹åˆ†å¸ƒå›¾é€šè¿‡é™ç»´å±•ç¤ºé«˜ç»´ç‰¹å¾ç©ºé—´ä¸­çš„å‘Šè­¦æ•°æ®åˆ†å¸ƒã€‚</p>
                        <ul>
                            <li><strong>ç‚¹çš„é¢œè‰²ï¼š</strong> è¡¨ç¤ºå¼‚å¸¸åˆ†æ•°ï¼Œä»ç»¿è‰²ï¼ˆæ­£å¸¸ï¼‰åˆ°çº¢è‰²ï¼ˆå¼‚å¸¸ï¼‰</li>
                            <li><strong>ç‚¹çš„å¤§å°ï¼š</strong> è¡¨ç¤ºé›¶æ—¥æ”»å‡»é£é™©åˆ†æ•°ï¼Œåˆ†æ•°è¶Šé«˜ç‚¹è¶Šå¤§</li>
                            <li><strong>é»‘è‰²è±å½¢ï¼š</strong> è¡¨ç¤ºèšç±»ä¸­å¿ƒä½ç½®</li>
                        </ul>
                        <p>æ­¤å›¾è¡¨å¯ä»¥ç›´è§‚åœ°å±•ç¤ºAIç³»ç»Ÿå¯¹å‘Šè­¦æ•°æ®çš„èšç±»å’Œå¼‚å¸¸æ£€æµ‹æ•ˆæœã€‚</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="./js/utils.js"></script>
    <script src="./js/api.js"></script>
    <script>
        // å›¾è¡¨å®ä¾‹
        const charts = {
            dailyAlerts: null,
            categoryDistribution: null,
            monthlyTrend: null,
            ipAttackStats: null,
            modelDistribution: null
        };

        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function () {
            // åŠ è½½æ‰€æœ‰å›¾è¡¨
            loadAllCharts();

            // æ·»åŠ äº‹ä»¶ç›‘å¬
            document.getElementById('refresh-charts').addEventListener('click', loadAllCharts);

            document.getElementById('model-chart-days').addEventListener('change', function () {
                loadModelDistributionChart();
            });

            document.getElementById('export-charts').addEventListener('click', exportCharts);

            // æ£€æŸ¥å¥åº·çŠ¶æ€
            checkHealth();

            // çª—å£å¤§å°å˜åŒ–æ—¶ï¼Œè°ƒæ•´å›¾è¡¨å¤§å°
            window.addEventListener('resize', resizeAllCharts);
        });

        // æ£€æŸ¥å¥åº·çŠ¶æ€
        async function checkHealth() {
            try {
                const result = await api.checkHealth();

                document.getElementById('header-status').innerHTML = `
          <div>
            <span class="tag ${result.status === 'ok' ? 'tag-success' : 'tag-error'}">
              ${result.status === 'ok' ? 'ç³»ç»Ÿæ­£å¸¸' : 'ç³»ç»Ÿå¼‚å¸¸'}
            </span>
            <span style="margin-left: 10px; font-size: 12px; color: var(--text-color-secondary);">
              ${utils.formatDate(result.time)}
            </span>
          </div>
        `;
            } catch (error) {
                document.getElementById('header-status').innerHTML = `
          <span class="tag tag-error">ç³»ç»Ÿå¼‚å¸¸</span>
        `;
            }
        }

        // åŠ è½½æ‰€æœ‰å›¾è¡¨
        function loadAllCharts() {
            loadDailyAlertsChart();
            loadCategoryDistributionChart();
            loadMonthlyTrendChart();
            loadIpAttackStatsChart();
            loadModelDistributionChart();
        }

        // è°ƒæ•´æ‰€æœ‰å›¾è¡¨å¤§å°
        function resizeAllCharts() {
            for (const key in charts) {
                if (charts[key]) {
                    charts[key].resize();
                }
            }
        }

        // åŠ è½½æ¯æ—¥å‘Šè­¦ç»Ÿè®¡å›¾è¡¨
        async function loadDailyAlertsChart() {
            try {
                utils.showLoading('#daily-alerts-chart', 'åŠ è½½æ¯æ—¥å‘Šè­¦ç»Ÿè®¡...');

                const result = await api.getChartData('daily_alerts');

                if (result.status === 'success') {
                    const chartDom = document.getElementById('daily-alerts-chart');
                    chartDom.innerHTML = '';

                    // ä½¿ç”¨æ–°çš„å›¾è¡¨åˆå§‹åŒ–æ–¹æ³•
                    charts.dailyAlerts = utils.initChart('#daily-alerts-chart', result.data);
                } else {
                    throw new Error(result.message || 'åŠ è½½å›¾è¡¨å¤±è´¥');
                }
            } catch (error) {
                utils.showMessage(error.message, 'error');
                document.getElementById('daily-alerts-chart').innerHTML = `
          <div class="alert alert-error">
            <span class="alert-icon">âœ—</span> åŠ è½½å›¾è¡¨å¤±è´¥: ${error.message}
          </div>
        `;
            }
        }

        // åŠ è½½æ”»å‡»ç±»å‹åˆ†å¸ƒå›¾è¡¨
        async function loadCategoryDistributionChart() {
            try {
                utils.showLoading('#category-distribution-chart', 'åŠ è½½æ”»å‡»ç±»å‹åˆ†å¸ƒ...');

                const result = await api.getChartData('category_distribution');

                if (result.status === 'success') {
                    const chartDom = document.getElementById('category-distribution-chart');
                    chartDom.innerHTML = '';

                    // ä½¿ç”¨æ–°çš„å›¾è¡¨åˆå§‹åŒ–æ–¹æ³•
                    charts.categoryDistribution = utils.initChart('#category-distribution-chart', result.data);
                } else if (result.status === 'warning') {
                    document.getElementById('category-distribution-chart').innerHTML = `
            <div class="alert alert-warning">
              <span class="alert-icon">âš </span> ${result.message || 'æš‚æ— æ•°æ®'}
            </div>
          `;
                } else {
                    throw new Error(result.message || 'åŠ è½½å›¾è¡¨å¤±è´¥');
                }
            } catch (error) {
                utils.showMessage(error.message, 'error');
                document.getElementById('category-distribution-chart').innerHTML = `
          <div class="alert alert-error">
            <span class="alert-icon">âœ—</span> åŠ è½½å›¾è¡¨å¤±è´¥: ${error.message}
          </div>
        `;
            }
        }

        // åŠ è½½æœˆåº¦è¶‹åŠ¿å›¾è¡¨
        async function loadMonthlyTrendChart() {
            try {
                utils.showLoading('#monthly-trend-chart', 'åŠ è½½æœˆåº¦è¶‹åŠ¿...');

                const result = await api.getChartData('monthly_trend');

                if (result.status === 'success') {
                    const chartDom = document.getElementById('monthly-trend-chart');
                    chartDom.innerHTML = '';

                    // ä½¿ç”¨æ–°çš„å›¾è¡¨åˆå§‹åŒ–æ–¹æ³•
                    charts.monthlyTrend = utils.initChart('#monthly-trend-chart', result.data);
                } else if (result.status === 'warning') {
                    document.getElementById('monthly-trend-chart').innerHTML = `
            <div class="alert alert-warning">
              <span class="alert-icon">âš </span> ${result.message || 'æš‚æ— æ•°æ®'}
            </div>
          `;
                } else {
                    throw new Error(result.message || 'åŠ è½½å›¾è¡¨å¤±è´¥');
                }
            } catch (error) {
                utils.showMessage(error.message, 'error');
                document.getElementById('monthly-trend-chart').innerHTML = `
          <div class="alert alert-error">
            <span class="alert-icon">âœ—</span> åŠ è½½å›¾è¡¨å¤±è´¥: ${error.message}
          </div>
        `;
            }
        }

        // åŠ è½½IPæ”»å‡»ç»Ÿè®¡å›¾è¡¨
        async function loadIpAttackStatsChart() {
            try {
                utils.showLoading('#ip-attack-stats-chart', 'åŠ è½½IPæ”»å‡»ç»Ÿè®¡...');

                const result = await api.getChartData('ip_attack_stats');

                if (result.status === 'success') {
                    const chartDom = document.getElementById('ip-attack-stats-chart');
                    chartDom.innerHTML = '';

                    // ä½¿ç”¨æ–°çš„æ•°æ®æ ¼å¼
                    charts.ipAttackStats = utils.initChart(
                        '#ip-attack-stats-chart',
                        'horizontalBar',
                        result.data
                    );
                } else if (result.status === 'warning') {
                    document.getElementById('ip-attack-stats-chart').innerHTML = `
            <div class="alert alert-warning">
              <span class="alert-icon">âš </span> ${result.message || 'æš‚æ— æ•°æ®'}
            </div>
          `;
                } else {
                    throw new Error(result.message || 'åŠ è½½å›¾è¡¨å¤±è´¥');
                }
            } catch (error) {
                utils.showMessage(error.message, 'error');
                document.getElementById('ip-attack-stats-chart').innerHTML = `
          <div class="alert alert-error">
            <span class="alert-icon">âœ—</span> åŠ è½½å›¾è¡¨å¤±è´¥: ${error.message}
          </div>
        `;
            }
        }

        // åŠ è½½æ¨¡å‹æ•£ç‚¹å›¾
        async function loadModelDistributionChart() {
            try {
                utils.showLoading('#model-distribution-chart', 'åŠ è½½æ¨¡å‹æ•£ç‚¹å›¾...');

                // è·å–æ•°æ®èŒƒå›´
                const days = document.getElementById('model-chart-days').value;

                const result = await api.getChartData('model_distribution', { days });

                if (result.status === 'success') {
                    const chartDom = document.getElementById('model-distribution-chart');
                    chartDom.innerHTML = '';

                    // ä½¿ç”¨æ–°çš„å›¾è¡¨åˆå§‹åŒ–æ–¹æ³•ï¼Œæ•£ç‚¹å›¾ç±»å‹
                    charts.modelDistribution = utils.initChart('#model-distribution-chart', 'scatter', result.data);
                } else if (result.status === 'warning') {
                    document.getElementById('model-distribution-chart').innerHTML = `
                        <div class="alert alert-warning">
                            <span class="alert-icon">âš </span> ${result.message || 'æš‚æ— æ•°æ®'}
                        </div>
                    `;
                } else {
                    throw new Error(result.message || 'åŠ è½½å›¾è¡¨å¤±è´¥');
                }
            } catch (error) {
                utils.showMessage(error.message, 'error');
                document.getElementById('model-distribution-chart').innerHTML = `
                    <div class="alert alert-error">
                        <span class="alert-icon">âœ—</span> åŠ è½½å›¾è¡¨å¤±è´¥: ${error.message}
                    </div>
                `;
            }
        }

        // å¯¼å‡ºå›¾è¡¨ä¸ºå›¾ç‰‡
        function exportCharts() {
            try {
                // åˆ›å»ºä¸€ä¸ªä¸´æ—¶é“¾æ¥ç”¨äºä¸‹è½½
                const download = function (url, filename) {
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    a.click();
                };

                // å¯¼å‡ºæ¯ä¸ªå›¾è¡¨
                for (const key in charts) {
                    if (charts[key]) {
                        const url = charts[key].getDataURL({
                            type: 'png',
                            pixelRatio: 2,
                            backgroundColor: '#fff'
                        });

                        download(url, `ai-ids-${key}-${new Date().toISOString().slice(0, 10)}.png`);
                    }
                }

                utils.showMessage('å·²å¯¼å‡ºæ‰€æœ‰å›¾è¡¨', 'success');
            } catch (error) {
                utils.showMessage('å¯¼å‡ºå›¾è¡¨å¤±è´¥: ' + error.message, 'error');
            }
        }
    </script>

    <style>
        /* é¡µé¢ç‰¹å®šæ ·å¼ */
        .chart-controls {
            margin-top: 15px;
        }

        .chart-description {
            margin-top: 15px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 4px;
        }

        .chart-description p {
            margin-bottom: 10px;
        }

        .chart-description ul {
            padding-left: 20px;
            margin-bottom: 10px;
        }

        .chart-description li {
            margin-bottom: 5px;
        }

        .legend-item {
            display: inline-flex;
            align-items: center;
            margin-right: 15px;
            font-size: 12px;
        }

        .legend-color {
            display: inline-block;
            width: 12px;
            height: 12px;
            margin-right: 5px;
            border-radius: 2px;
        }
    </style>
</body>

</html>