<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-IDS - æ•°æ®å¯è§†åŒ–</title>
    <link rel="stylesheet" href="./css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
</head>

<body>
    <div class="app-container">
        <!-- å¤´éƒ¨å¯¼èˆª -->
        <header class="header">
            <div class="navbar-brand">
                <div class="logo-text">AI-IDS</div>
            </div>
            <div id="header-status"></div>
        </header>

        <!-- ä¸»ä½“å†…å®¹ -->
        <div class="main-container">
            <!-- ä¾§è¾¹æ  -->
            <div class="sidebar">
                <ul class="nav-menu">
                    <li class="nav-menu-item" onclick="location.href='./model-management.html'">
                        <span class="nav-menu-icon">âš™ï¸</span> æ¨¡å‹ç®¡ç†
                    </li>
                    <li class="nav-menu-item" onclick="location.href='./zeroday-history.html'">
                        <span class="nav-menu-icon">ğŸ”</span> é›¶æ—¥æ”»å‡»å†å²
                    </li>
                    <li class="nav-menu-item active" onclick="location.href='./data-visualization.html'">
                        <span class="nav-menu-icon">ğŸ“Š</span> æ•°æ®å¯è§†åŒ–
                    </li>
                </ul>
            </div>

            <!-- å†…å®¹åŒºåŸŸ -->
            <div class="content">
                <h1>æ•°æ®å¯è§†åŒ–</h1>

                <!-- å›¾è¡¨å±•ç¤ºåŒºåŸŸ -->
                <div class="row">
                    <!-- å‘Šè­¦ç»Ÿè®¡ -->
                    <div class="col col-6">
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">å‘Šè­¦ç»Ÿè®¡</h2>
                                <div class="chart-controls">
                                    <label for="daily-alerts-days">æ•°æ®èŒƒå›´ï¼š</label>
                                    <select id="daily-alerts-days">
                                        <option value="3">æœ€è¿‘3å¤©</option>
                                        <option value="7">æœ€è¿‘7å¤©</option>
                                        <option value="14">æœ€è¿‘14å¤©</option>
                                        <option value="30" selected>æœ€è¿‘30å¤©</option>
                                    </select>
                                </div>
                            </div>
                            <div class="chart-container" style="height: 400px;" id="daily-alerts-chart">
                                <div class="loading">
                                    <div class="loading-spinner"></div>
                                    <span>åŠ è½½ä¸­...</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æ”»å‡»ç±»å‹åˆ†å¸ƒ -->
                    <div class="col col-6">
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">é›¶æ—¥æ”»å‡»ç±»å‹åˆ†å¸ƒ</h2>
                                <div class="chart-controls">
                                    <label for="category-distribution-days">æ•°æ®èŒƒå›´ï¼š</label>
                                    <select id="category-distribution-days">
                                        <option value="3">æœ€è¿‘3å¤©</option>
                                        <option value="7" selected>æœ€è¿‘7å¤©</option>
                                        <option value="14">æœ€è¿‘14å¤©</option>
                                        <option value="30">æœ€è¿‘30å¤©</option>
                                    </select>
                                </div>
                            </div>
                            <div class="chart-container" id="category-distribution-chart">
                                <div class="loading">
                                    <div class="loading-spinner"></div>
                                    <span>åŠ è½½ä¸­...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- å¼‚å¸¸å‘Šè­¦æ—¶é—´çƒ­åŠ›å›¾ -->
                    <div class="col col-6">
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">å¼‚å¸¸å‘Šè­¦æ—¶é—´åˆ†å¸ƒ</h2>
                                <div class="chart-controls">
                                    <label for="time-heatmap-days">æ•°æ®èŒƒå›´ï¼š</label>
                                    <select id="time-heatmap-days">
                                        <option value="3">æœ€è¿‘3å¤©</option>
                                        <option value="7" selected>æœ€è¿‘7å¤©</option>
                                        <option value="14">æœ€è¿‘14å¤©</option>
                                        <option value="30">æœ€è¿‘30å¤©</option>
                                    </select>
                                </div>
                            </div>
                            <div class="chart-container" id="time-heatmap-chart">
                                <div class="loading">
                                    <div class="loading-spinner"></div>
                                    <span>åŠ è½½ä¸­...</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æºIPç»Ÿè®¡ -->
                    <div class="col col-6">
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">æ”»å‡»æºIPç»Ÿè®¡</h2>
                                <div class="chart-controls">
                                    <label for="ip-attack-stats-days">æ•°æ®èŒƒå›´ï¼š</label>
                                    <select id="ip-attack-stats-days">
                                        <option value="3">æœ€è¿‘3å¤©</option>
                                        <option value="7" selected>æœ€è¿‘7å¤©</option>
                                        <option value="14">æœ€è¿‘14å¤©</option>
                                        <option value="30">æœ€è¿‘30å¤©</option>
                                    </select>
                                </div>
                            </div>
                            <div class="chart-container" id="ip-attack-stats-chart">
                                <div class="loading">
                                    <div class="loading-spinner"></div>
                                    <span>åŠ è½½ä¸­...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å‘Šè­¦å¯¹æ¯”åˆ†æ -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">å‘Šè­¦å¯¹æ¯”åˆ†æ</h2>
                        <div class="chart-controls">
                            <label for="alert-comparison-days">æ•°æ®èŒƒå›´ï¼š</label>
                            <select id="alert-comparison-days">
                                <option value="3">æœ€è¿‘3å¤©</option>
                                <option value="7">æœ€è¿‘7å¤©</option>
                                <option value="14">æœ€è¿‘14å¤©</option>
                                <option value="30" selected>æœ€è¿‘30å¤©</option>
                            </select>
                        </div>
                    </div>
                    <div class="chart-container" style="height: 500px;" id="alert-comparison-chart">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                            <span>åŠ è½½ä¸­...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script src="./js/utils.js"></script>
        <script src="./js/api.js"></script>
        <script>
            // å›¾è¡¨å®ä¾‹
            const charts = {
                dailyAlerts: null,
                categoryDistribution: null,
                timeHeatmap: null,
                ipAttackStats: null,
                alertComparison: null
            };

            // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
            document.addEventListener('DOMContentLoaded', function () {
                loadAllCharts();
                checkHealth();

                // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
                document.getElementById('daily-alerts-days').addEventListener('change', function () {
                    loadDailyAlertsChart();
                });

                document.getElementById('category-distribution-days').addEventListener('change', function () {
                    loadCategoryDistributionChart();
                });

                document.getElementById('time-heatmap-days').addEventListener('change', function () {
                    loadTimeHeatmapChart();
                });

                document.getElementById('ip-attack-stats-days').addEventListener('change', function () {
                    loadIpAttackStatsChart();
                });

                document.getElementById('alert-comparison-days').addEventListener('change', function () {
                    loadAlertComparisonChart();
                });

                // çª—å£å¤§å°æ”¹å˜æ—¶é‡æ–°è°ƒæ•´å›¾è¡¨å¤§å°
                window.addEventListener('resize', resizeAllCharts);
            });

            // æ£€æŸ¥å¥åº·çŠ¶æ€
            async function checkHealth() {
                try {
                    const result = await api.checkHealth();

                    document.getElementById('header-status').innerHTML = `
          <div>
            <span class="tag ${result.status === 'ok' ? 'tag-success' : 'tag-error'}">
              ${result.status === 'ok' ? 'ç³»ç»Ÿæ­£å¸¸' : 'ç³»ç»Ÿå¼‚å¸¸'}
            </span>
            <span style="margin-left: 10px; font-size: 12px; color: var(--text-color-secondary);">
              ${utils.formatDate(result.time)}
            </span>
          </div>
        `;
                } catch (error) {
                    document.getElementById('header-status').innerHTML = `
          <span class="tag tag-error">ç³»ç»Ÿå¼‚å¸¸</span>
        `;
                }
            }

            // åŠ è½½æ‰€æœ‰å›¾è¡¨
            function loadAllCharts() {
                loadDailyAlertsChart();
                loadCategoryDistributionChart();
                loadTimeHeatmapChart();
                loadIpAttackStatsChart();
                loadAlertComparisonChart();
            }

            // è°ƒæ•´æ‰€æœ‰å›¾è¡¨å¤§å°
            function resizeAllCharts() {
                for (const key in charts) {
                    if (charts[key]) {
                        charts[key].resize();
                    }
                }
            }

            // åŠ è½½å‘Šè­¦ç»Ÿè®¡å›¾è¡¨
            async function loadDailyAlertsChart() {
                try {
                    utils.showLoading('#daily-alerts-chart', 'åŠ è½½å‘Šè­¦ç»Ÿè®¡...');

                    const days = document.getElementById('daily-alerts-days').value;
                    const result = await api.getChartData('daily_alerts', { days });

                    // æ£€æŸ¥æ˜¯å¦ä¸ºè­¦å‘Šå“åº”
                    if (result._response?.code === 1) {
                        document.getElementById('daily-alerts-chart').innerHTML = `
            <div class="alert alert-warning">
              <span class="alert-icon">âš </span> ${result._response?.message || 'æš‚æ— æ•°æ®'}
            </div>
          `;
                    } else {
                        const chartDom = document.getElementById('daily-alerts-chart');
                        chartDom.innerHTML = '';

                        // ä½¿ç”¨æŸ±çŠ¶å›¾ç±»å‹åˆå§‹åŒ–å›¾è¡¨
                        charts.dailyAlerts = utils.initChart('#daily-alerts-chart', 'bar', result);
                    }
                } catch (error) {
                    utils.showMessage(error.message, 'error');
                    document.getElementById('daily-alerts-chart').innerHTML = `
          <div class="alert alert-error">
            <span class="alert-icon">âœ—</span> åŠ è½½å›¾è¡¨å¤±è´¥: ${error.message}
          </div>
        `;
                }
            }

            // åŠ è½½æ”»å‡»ç±»å‹åˆ†å¸ƒå›¾è¡¨
            async function loadCategoryDistributionChart() {
                try {
                    utils.showLoading('#category-distribution-chart', 'åŠ è½½æ”»å‡»ç±»å‹åˆ†å¸ƒ...');

                    const days = document.getElementById('category-distribution-days').value;
                    const result = await api.getChartData('category_distribution', { days });

                    // æ£€æŸ¥æ˜¯å¦ä¸ºè­¦å‘Šå“åº”
                    if (result._response?.code === 1) {
                        document.getElementById('category-distribution-chart').innerHTML = `
            <div class="alert alert-warning">
              <span class="alert-icon">âš </span> ${result._response?.message || 'æš‚æ— æ•°æ®'}
            </div>
          `;
                    } else {
                        const chartDom = document.getElementById('category-distribution-chart');
                        chartDom.innerHTML = '';

                        // ä½¿ç”¨é¥¼å›¾ç±»å‹åˆå§‹åŒ–å›¾è¡¨
                        charts.categoryDistribution = utils.initChart('#category-distribution-chart', 'pie', result);
                    }
                } catch (error) {
                    utils.showMessage(error.message, 'error');
                    document.getElementById('category-distribution-chart').innerHTML = `
          <div class="alert alert-error">
            <span class="alert-icon">âœ—</span> åŠ è½½å›¾è¡¨å¤±è´¥: ${error.message}
          </div>
        `;
                }
            }

            // åŠ è½½å¼‚å¸¸å‘Šè­¦æ—¶é—´çƒ­åŠ›å›¾è¡¨
            async function loadTimeHeatmapChart() {
                try {
                    utils.showLoading('#time-heatmap-chart', 'åŠ è½½å¼‚å¸¸å‘Šè­¦æ—¶é—´åˆ†å¸ƒ...');

                    const days = document.getElementById('time-heatmap-days').value;
                    const result = await api.getChartData('time_heatmap', { days });

                    // æ£€æŸ¥æ˜¯å¦ä¸ºè­¦å‘Šå“åº”
                    if (result._response?.code === 1) {
                        document.getElementById('time-heatmap-chart').innerHTML = `
            <div class="alert alert-warning">
              <span class="alert-icon">âš </span> ${result._response?.message || 'æš‚æ— æ•°æ®'}
            </div>
          `;
                    } else {
                        const chartDom = document.getElementById('time-heatmap-chart');
                        chartDom.innerHTML = '';

                        // ä½¿ç”¨çƒ­åŠ›å›¾ç±»å‹åˆå§‹åŒ–å›¾è¡¨
                        charts.timeHeatmap = utils.initChart('#time-heatmap-chart', 'heatmap', result);
                    }
                } catch (error) {
                    utils.showMessage(error.message, 'error');
                    document.getElementById('time-heatmap-chart').innerHTML = `
          <div class="alert alert-error">
            <span class="alert-icon">âœ—</span> åŠ è½½å›¾è¡¨å¤±è´¥: ${error.message}
          </div>
        `;
                }
            }

            // åŠ è½½IPæ”»å‡»ç»Ÿè®¡å›¾è¡¨
            async function loadIpAttackStatsChart() {
                try {
                    utils.showLoading('#ip-attack-stats-chart', 'åŠ è½½IPæ”»å‡»ç»Ÿè®¡...');

                    const days = document.getElementById('ip-attack-stats-days').value;
                    const result = await api.getChartData('ip_attack_stats', { days });

                    // æ£€æŸ¥æ˜¯å¦ä¸ºè­¦å‘Šå“åº”
                    if (result._response?.code === 1) {
                        document.getElementById('ip-attack-stats-chart').innerHTML = `
            <div class="alert alert-warning">
              <span class="alert-icon">âš </span> ${result._response?.message || 'æš‚æ— æ•°æ®'}
            </div>
          `;
                    } else {
                        const chartDom = document.getElementById('ip-attack-stats-chart');
                        chartDom.innerHTML = '';

                        // ä½¿ç”¨æ–°çš„æ•°æ®æ ¼å¼
                        charts.ipAttackStats = utils.initChart(
                            '#ip-attack-stats-chart',
                            'horizontalBar',
                            result
                        );
                    }
                } catch (error) {
                    utils.showMessage(error.message, 'error');
                    document.getElementById('ip-attack-stats-chart').innerHTML = `
          <div class="alert alert-error">
            <span class="alert-icon">âœ—</span> åŠ è½½å›¾è¡¨å¤±è´¥: ${error.message}
          </div>
        `;
                }
            }

            // åŠ è½½å‘Šè­¦å¯¹æ¯”åˆ†æå›¾è¡¨
            async function loadAlertComparisonChart() {
                try {
                    const chartContainer = document.getElementById('alert-comparison-chart');

                    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                    utils.showLoading('#alert-comparison-chart', 'åŠ è½½å‘Šè­¦å¯¹æ¯”åˆ†æ...');

                    // å¦‚æœå›¾è¡¨å·²å­˜åœ¨ï¼Œå…ˆå®‰å…¨åœ°é”€æ¯å®ƒ
                    if (charts.alertComparison) {
                        try {
                            charts.alertComparison.dispose();
                        } catch (e) {
                            console.warn('é”€æ¯å›¾è¡¨æ—¶å‡ºç°è­¦å‘Š:', e);
                        }
                        charts.alertComparison = null;
                    }

                    // è·å–æ•°æ®èŒƒå›´
                    const days = document.getElementById('alert-comparison-days').value;

                    const result = await api.getChartData('daily_alert_comparison', { days });

                    // æ£€æŸ¥æ˜¯å¦ä¸ºè­¦å‘Šå“åº”
                    if (result._response?.code === 1) {
                        chartContainer.innerHTML = `
            <div class="alert alert-warning">
              <span class="alert-icon">âš </span> ${result._response?.message || 'æš‚æ— æ•°æ®'}
            </div>
          `;
                    } else {
                        // æ¸…ç©ºå®¹å™¨å†…å®¹
                        chartContainer.innerHTML = '';

                        // ä½¿ç”¨å¤šçº¿å›¾è¡¨ç±»å‹åˆå§‹åŒ–å›¾è¡¨
                        charts.alertComparison = utils.initChart('#alert-comparison-chart', 'multiLine', result);
                    }
                } catch (error) {
                    utils.showMessage(error.message, 'error');
                    document.getElementById('alert-comparison-chart').innerHTML = `
          <div class="alert alert-error">
            <span class="alert-icon">âœ—</span> åŠ è½½å›¾è¡¨å¤±è´¥: ${error.message}
          </div>
        `;
                }
            }
        </script>

        <style>
            /* é¡µé¢ç‰¹å®šæ ·å¼ */
            .chart-controls {
                margin-top: 15px;
            }

            .chart-controls label {
                font-weight: 500;
                margin-right: 8px;
                color: #333;
            }

            .chart-controls select {
                padding: 6px 12px;
                border: 1px solid #d9d9d9;
                border-radius: 4px;
                background-color: #fff;
                font-size: 14px;
                color: #333;
                cursor: pointer;
            }

            .chart-controls select:hover {
                border-color: #40a9ff;
            }

            .chart-controls select:focus {
                outline: none;
                border-color: #40a9ff;
                box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
            }
        </style>
</body>

</html>