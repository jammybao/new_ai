<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-IDS - æ¨¡å‹ç®¡ç†</title>
    <link rel="stylesheet" href="./css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
</head>

<body>
    <div class="app-container">
        <!-- å¤´éƒ¨å¯¼èˆª -->
        <header class="header">
            <div class="navbar-brand">
                <div class="logo-text">AI-IDS</div>
            </div>
            <div id="header-status"></div>
        </header>

        <!-- ä¸»ä½“å†…å®¹ -->
        <div class="main-container">
            <!-- ä¾§è¾¹æ  -->
            <div class="sidebar">
                <ul class="nav-menu">
                    <li class="nav-menu-item active" onclick="location.href='./model-management.html'">
                        <span class="nav-menu-icon">âš™ï¸</span> æ¨¡å‹ç®¡ç†
                    </li>
                    <li class="nav-menu-item" onclick="location.href='./zeroday-history.html'">
                        <span class="nav-menu-icon">ğŸ”</span> é›¶æ—¥æ”»å‡»å†å²
                    </li>
                    <li class="nav-menu-item" onclick="location.href='./data-visualization.html'">
                        <span class="nav-menu-icon">ğŸ“Š</span> æ•°æ®å¯è§†åŒ–
                    </li>
                </ul>
            </div>

            <!-- å†…å®¹åŒºåŸŸ -->
            <div class="content">
                <h1>æ¨¡å‹ç®¡ç†</h1>

                <!-- çŠ¶æ€æ¦‚è§ˆ -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">ç³»ç»ŸçŠ¶æ€</h2>
                        <button class="btn btn-primary" id="refresh-status">
                            <span class="btn-icon">ğŸ”„</span> åˆ·æ–°
                        </button>
                    </div>
                    <div id="system-status-content">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                            <span>åŠ è½½ä¸­...</span>
                        </div>
                    </div>
                </div>

                <!-- æ¨¡å‹æ›´æ–° -->
                <div class="row">
                    <!-- åŸºçº¿æ•°æ®æ›´æ–° -->
                    <div class="col col-6">
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">åŸºçº¿æ•°æ®æ›´æ–°</h2>
                            </div>
                            <div class="form-group">
                                <label class="form-label">æ•°æ®æ—¶é—´èŒƒå›´ (å¤©)</label>
                                <input type="number" class="form-control" id="baseline-days" value="30" min="1"
                                    max="365">
                            </div>
                            <div class="form-group">
                                <label class="form-label">æœ€å°ç½®ä¿¡åº¦åˆ†æ•° (0-1)</label>
                                <input type="number" class="form-control" id="baseline-score" value="0.5" min="0"
                                    max="1" step="0.1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">æ’é™¤æ”»å‡»ç±»å‹</label>
                                <div class="exclude-categories">
                                    <label>
                                        <input type="checkbox" value="ä¸¥é‡æ¼æ´" checked> ä¸¥é‡æ¼æ´
                                    </label>
                                    <label>
                                        <input type="checkbox" value="å‹’ç´¢è½¯ä»¶" checked> å‹’ç´¢è½¯ä»¶
                                    </label>
                                    <label>
                                        <input type="checkbox" value="æ•°æ®æ³„éœ²" checked> æ•°æ®æ³„éœ²
                                    </label>
                                </div>
                            </div>
                            <button class="btn btn-success" id="update-baseline">
                                <span class="btn-icon">â†»</span> æ›´æ–°åŸºçº¿æ•°æ®
                            </button>
                            <div id="baseline-update-result" class="mt-3"></div>
                        </div>
                    </div>

                    <!-- æ¨¡å‹è®­ç»ƒ -->
                    <div class="col col-6">
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">æ¨¡å‹è®­ç»ƒ</h2>
                            </div>
                            <p class="mb-4">
                                è®­ç»ƒå°†ä½¿ç”¨æœ€æ–°çš„åŸºçº¿æ•°æ®ï¼Œé€šè¿‡æœºå™¨å­¦ä¹ ç®—æ³•æ„å»ºåŸºçº¿æ¨¡å‹å’Œé›¶æ—¥æ£€æµ‹å™¨ã€‚
                                è®­ç»ƒè¿‡ç¨‹å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…ã€‚
                            </p>
                            <div class="alert alert-info">
                                <span class="alert-icon">â„¹</span>
                                æ¨¡å‹è®­ç»ƒé»˜è®¤ä½¿ç”¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½®çš„å‚æ•°ï¼Œè®­ç»ƒçª—å£ä¸ºæœ€è¿‘90å¤©çš„æ•°æ®ã€‚
                            </div>
                            <button class="btn btn-primary" id="train-model">
                                <span class="btn-icon">ğŸ§ </span> è®­ç»ƒæ¨¡å‹
                            </button>
                            <div id="model-train-result" class="mt-3"></div>
                        </div>
                    </div>
                </div>

                <!-- é›¶æ—¥æ£€æµ‹ -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">æ‰‹åŠ¨æ‰§è¡Œé›¶æ—¥æ”»å‡»æ£€æµ‹</h2>
                    </div>
                    <div class="form-group">
                        <label class="form-label">æ£€æµ‹æ—¶é—´èŒƒå›´ (å°æ—¶)</label>
                        <input type="number" class="form-control" id="detection-hours" value="2" min="1" max="72">
                    </div>
                    <button class="btn btn-warning" id="detect-zeroday">
                        <span class="btn-icon">ğŸ”</span> æ‰§è¡Œæ£€æµ‹
                    </button>
                    <div id="detection-result" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="./js/utils.js"></script>
    <script src="./js/api.js"></script>
    <script>
        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function () {
            // åŠ è½½ç³»ç»ŸçŠ¶æ€
            loadSystemStatus();

            // æ·»åŠ äº‹ä»¶ç›‘å¬
            document.getElementById('refresh-status').addEventListener('click', loadSystemStatus);
            document.getElementById('update-baseline').addEventListener('click', updateBaseline);
            document.getElementById('train-model').addEventListener('click', trainModel);
            document.getElementById('detect-zeroday').addEventListener('click', detectZeroDay);
        });

        // åŠ è½½ç³»ç»ŸçŠ¶æ€
        async function loadSystemStatus() {
            try {
                utils.showLoading('#system-status-content', 'åŠ è½½ç³»ç»ŸçŠ¶æ€...');

                // è·å–ç³»ç»Ÿç‰ˆæœ¬ä¿¡æ¯
                const result = await api.getSystemVersions();

                if (result.status === 'success') {
                    // æ¸²æŸ“ç³»ç»ŸçŠ¶æ€
                    renderSystemStatus(result);
                } else {
                    throw new Error(result.message || 'è·å–ç³»ç»ŸçŠ¶æ€å¤±è´¥');
                }
            } catch (error) {
                utils.showMessage(error.message, 'error');
                document.getElementById('system-status-content').innerHTML = `
          <div class="alert alert-error">
            <span class="alert-icon">âœ—</span> åŠ è½½ç³»ç»ŸçŠ¶æ€å¤±è´¥: ${error.message}
          </div>
        `;
            }
        }

        // æ¸²æŸ“ç³»ç»ŸçŠ¶æ€
        function renderSystemStatus(data) {
            const { versions, system_time } = data;

            // è·å–å¥åº·çŠ¶æ€
            api.checkHealth().then(healthData => {
                document.getElementById('header-status').innerHTML = `
          <div>
            <span class="tag ${healthData.status === 'ok' ? 'tag-success' : 'tag-error'}">
              ${healthData.status === 'ok' ? 'ç³»ç»Ÿæ­£å¸¸' : 'ç³»ç»Ÿå¼‚å¸¸'}
            </span>
            <span style="margin-left: 10px; font-size: 12px; color: var(--text-color-secondary);">
              ${utils.formatDate(system_time)}
            </span>
          </div>
        `;
            }).catch(err => {
                document.getElementById('header-status').innerHTML = `
          <span class="tag tag-error">ç³»ç»Ÿå¼‚å¸¸</span>
        `;
            });

            // æ¸²æŸ“çŠ¶æ€å†…å®¹
            const statusHtml = `
        <div class="row">
          <div class="col col-3">
            <div class="status-item">
              <div class="status-label">åŸºçº¿æ•°æ®</div>
              <div class="status-value">
                ${utils.formatNumber(versions.baseline_data.count || 0)} æ¡
              </div>
              <div class="status-time">
                ${versions.baseline_data.last_update ? `æ›´æ–°äº: ${utils.formatDate(versions.baseline_data.last_update, 'YYYY-MM-DD HH:mm')}` : 'å°šæœªæ›´æ–°'}
              </div>
            </div>
          </div>
          <div class="col col-3">
            <div class="status-item">
              <div class="status-label">åŸºçº¿æ¨¡å‹</div>
              <div class="status-value">
                ${versions.baseline_model.last_update ? 'å·²è®­ç»ƒ' : 'æœªè®­ç»ƒ'}
              </div>
              <div class="status-time">
                ${versions.baseline_model.last_update ? `æ›´æ–°äº: ${utils.formatDate(versions.baseline_model.last_update, 'YYYY-MM-DD HH:mm')}` : 'å°šæœªè®­ç»ƒ'}
              </div>
            </div>
          </div>
          <div class="col col-3">
            <div class="status-item">
              <div class="status-label">é›¶æ—¥æ£€æµ‹æ¨¡å‹</div>
              <div class="status-value">
                ${versions.zero_day_model.last_update ? 'å·²è®­ç»ƒ' : 'æœªè®­ç»ƒ'}
              </div>
              <div class="status-time">
                ${versions.zero_day_model.last_update ? `æ›´æ–°äº: ${utils.formatDate(versions.zero_day_model.last_update, 'YYYY-MM-DD HH:mm')}` : 'å°šæœªè®­ç»ƒ'}
              </div>
            </div>
          </div>
          <div class="col col-3">
            <div class="status-item">
              <div class="status-label">æœ€è¿‘æ£€æµ‹</div>
              <div class="status-value">
                ${utils.formatNumber(versions.last_detection.count || 0)} æ¡é›¶æ—¥æ”»å‡»
              </div>
              <div class="status-time">
                ${versions.last_detection.last_update ? `æ£€æµ‹äº: ${utils.formatDate(versions.last_detection.last_update, 'YYYY-MM-DD HH:mm')}` : 'å°šæœªæ‰§è¡Œæ£€æµ‹'}
              </div>
            </div>
          </div>
        </div>
      `;

            document.getElementById('system-status-content').innerHTML = statusHtml;
        }

        // æ›´æ–°åŸºçº¿æ•°æ®
        async function updateBaseline() {
            try {
                // è·å–å‚æ•°
                const days = parseInt(document.getElementById('baseline-days').value) || 30;
                const minScore = parseFloat(document.getElementById('baseline-score').value) || 0.5;

                // è·å–æ’é™¤ç±»åˆ«
                const excludeCategories = Array.from(
                    document.querySelectorAll('.exclude-categories input:checked')
                ).map(input => input.value);

                const resultEl = document.getElementById('baseline-update-result');
                resultEl.innerHTML = `
          <div class="loading">
            <div class="loading-spinner"></div>
            <span>æ­£åœ¨æ›´æ–°åŸºçº¿æ•°æ®...</span>
          </div>
        `;

                // è°ƒç”¨API
                const result = await api.updateBaseline({
                    days,
                    min_score: minScore,
                    exclude_categories: excludeCategories
                });

                if (result.status === 'success') {
                    resultEl.innerHTML = `
            <div class="alert alert-success">
              <span class="alert-icon">âœ“</span> ${result.message || 'åŸºçº¿æ•°æ®æ›´æ–°æˆåŠŸ'}
            </div>
            <div class="mt-2">
              æ·»åŠ äº† ${result.added_count} æ¡è®°å½•
              <br>
              æ›´æ–°æ—¶é—´: ${utils.formatDate(result.update_time)}
            </div>
          `;

                    // åˆ·æ–°ç³»ç»ŸçŠ¶æ€
                    loadSystemStatus();
                } else {
                    throw new Error(result.message || 'æ›´æ–°åŸºçº¿æ•°æ®å¤±è´¥');
                }
            } catch (error) {
                document.getElementById('baseline-update-result').innerHTML = `
          <div class="alert alert-error">
            <span class="alert-icon">âœ—</span> æ›´æ–°å¤±è´¥: ${error.message}
          </div>
        `;
            }
        }

        // è®­ç»ƒæ¨¡å‹
        async function trainModel() {
            try {
                const resultEl = document.getElementById('model-train-result');
                resultEl.innerHTML = `
          <div class="loading">
            <div class="loading-spinner"></div>
            <span>æ­£åœ¨è®­ç»ƒæ¨¡å‹ï¼Œè¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´...</span>
          </div>
        `;

                // è°ƒç”¨API
                const result = await api.trainBaseline();

                if (result.status === 'success') {
                    resultEl.innerHTML = `
            <div class="alert alert-success">
              <span class="alert-icon">âœ“</span> ${result.message || 'æ¨¡å‹è®­ç»ƒæˆåŠŸ'}
            </div>
            <div class="mt-2">
              æ›´æ–°æ—¶é—´: ${utils.formatDate(result.update_time)}
            </div>
          `;

                    // åˆ·æ–°ç³»ç»ŸçŠ¶æ€
                    loadSystemStatus();
                } else {
                    throw new Error(result.message || 'è®­ç»ƒæ¨¡å‹å¤±è´¥');
                }
            } catch (error) {
                document.getElementById('model-train-result').innerHTML = `
          <div class="alert alert-error">
            <span class="alert-icon">âœ—</span> è®­ç»ƒå¤±è´¥: ${error.message}
          </div>
        `;
            }
        }

        // æ‰§è¡Œé›¶æ—¥æ”»å‡»æ£€æµ‹
        async function detectZeroDay() {
            try {
                // è·å–å‚æ•°
                const hours = parseInt(document.getElementById('detection-hours').value) || 2;

                const resultEl = document.getElementById('detection-result');
                resultEl.innerHTML = `
          <div class="loading">
            <div class="loading-spinner"></div>
            <span>æ­£åœ¨æ‰§è¡Œé›¶æ—¥æ”»å‡»æ£€æµ‹...</span>
          </div>
        `;

                // è°ƒç”¨API
                const result = await api.detectZeroDay({ hours });

                if (result.status === 'success') {
                    // æˆåŠŸæƒ…å†µ
                    resultEl.innerHTML = `
            <div class="alert alert-success">
              <span class="alert-icon">âœ“</span> ${result.message || 'æ£€æµ‹å®Œæˆ'}
            </div>
            <div class="mt-3">
              <div>æ€»å‘Šè­¦æ•°: ${result.total_alerts}</div>
              <div>å¼‚å¸¸æ•°é‡: ${result.anomaly_count}</div>
              <div>é›¶æ—¥æ”»å‡»: ${result.zero_day_count}</div>
              <div>å·²ä¿å­˜è®°å½•: ${result.saved_count}</div>
            </div>
          `;

                    // å¦‚æœæœ‰é›¶æ—¥æ”»å‡»è¯¦æƒ…ï¼Œæ˜¾ç¤ºè¯¦æƒ…è¡¨æ ¼
                    if (result.zero_day_details && result.zero_day_details.length > 0) {
                        resultEl.innerHTML += `
              <div class="mt-3">
                <h3>é›¶æ—¥æ”»å‡»è¯¦æƒ…</h3>
                <table class="table">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>æ—¶é—´</th>
                      <th>ç±»å‹</th>
                      <th>æºIP</th>
                      <th>ç›®æ ‡IP</th>
                      <th>åˆ†æ•°</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${result.zero_day_details.map(item => `
                      <tr>
                        <td>${item.id}</td>
                        <td>${utils.formatDate(item.event_time)}</td>
                        <td>${item.category}</td>
                        <td>${item.src_ip}</td>
                        <td>${item.dst_ip}</td>
                        <td>${item.zero_day_score.toFixed(3)}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            `;
                    }

                    // åˆ·æ–°ç³»ç»ŸçŠ¶æ€
                    loadSystemStatus();
                } else if (result.status === 'warning') {
                    // è­¦å‘Šæƒ…å†µ
                    resultEl.innerHTML = `
            <div class="alert alert-warning">
              <span class="alert-icon">âš </span> ${result.message || 'æ£€æµ‹è­¦å‘Š'}
            </div>
          `;
                } else {
                    throw new Error(result.message || 'æ£€æµ‹å¤±è´¥');
                }
            } catch (error) {
                document.getElementById('detection-result').innerHTML = `
          <div class="alert alert-error">
            <span class="alert-icon">âœ—</span> æ£€æµ‹å¤±è´¥: ${error.message}
          </div>
        `;
            }
        }
    </script>
</body>

</html>